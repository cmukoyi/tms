# Azure DevOps CI/CD Pipeline for TMS Flask Application

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

variables:
  pythonVersion: '3.9'
  
stages:
  # ==========================================
  # Stage 1: Build and Test
  # ==========================================
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildJob
        displayName: 'Build Application'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(Build.SourcesDirectory)'
              includeRootFolder: false
              archiveType: 'tar'
              tarCompression: 'gz'
              archiveFile: '$(Build.ArtifactStagingDirectory)/tms-$(Build.BuildId).tar.gz'
              replaceExistingArchive: true
            displayName: 'Archive Application'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'tms-app'
              publishLocation: 'Container'
            displayName: 'Publish Artifact'

  # ==========================================
  # Stage 2: Deploy to Production
  # ==========================================
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployProductionJob
        displayName: 'Deploy to Production Server'
        environment:
          name: 'TMS-Production'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'tms-app'
                    downloadPath: '$(System.ArtifactsDirectory)'

                - script: |
                    echo "Artifact directory contents:"
                    ls -R $(System.ArtifactsDirectory)/tms-app/
                  displayName: 'Debug: List artifact files'

                - task: SSH@0
                  inputs:
                    sshEndpoint: 'TMS-Production-SSH'
                    runOptions: 'commands'
                    commands: |
                      # Stop the service  
                      sudo systemctl stop tms
                      # Prepare deployment directory
                      sudo rm -rf /tmp/tms-deploy
                      sudo mkdir -p /tmp/tms-deploy
                      sudo chmod 777 /tmp/tms-deploy
                    readyTimeout: '20000'
                  displayName: 'Stop Service and Prepare'

                - task: CopyFilesOverSSH@0
                  inputs:
                    sshEndpoint: 'TMS-Production-SSH'
                    sourceFolder: '$(System.ArtifactsDirectory)/tms-app/'
                    contents: '*.tar.gz'
                    targetFolder: '/tmp/tms-deploy'
                    cleanTargetFolder: true
                  displayName: 'Copy Files to Server'

                - task: SSH@0
                  inputs:
                    sshEndpoint: 'TMS-Production-SSH'
                    runOptions: 'inline'
                    inline: |
                      set -e && \
                      echo "=== Backup current deployment ===" && \
                      [ -d /var/www/tms ] && sudo tar -czf /tmp/tms-backup-$(date +%s).tar.gz -C /var/www tms || true && \
                      echo "=== Extracting deployment package ===" && \
                      sudo tar -xzf /tmp/tms-deploy/*.tar.gz -C /var/www/tms && \
                      echo "Extraction complete" && \
                      echo "=== Updating dependencies ===" && \
                      cd /var/www/tms && \
                      [ ! -d "venv" ] && echo "Creating virtualenv..." && sudo -u www-data python3 -m venv venv || true && \
                      sudo -H -u www-data bash -c 'source venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt' && \
                      echo "=== Setting permissions ===" && \
                      sudo chown -R www-data:www-data /var/www/tms && \
                      sudo chmod -R 755 /var/www/tms && \
                      echo "=== Verifying .env file ===" && \
                      [ -f /var/www/tms/.env ] || (echo "ERROR: .env file missing!" && exit 1) && \
                      echo ".env file exists" && \
                      echo "=== Starting TMS service ===" && \
                      sudo systemctl start tms && \
                      sleep 3 && \
                      sudo systemctl status tms --no-pager
                    readyTimeout: '20000'
                  displayName: 'Deploy and Restart Service'

                - task: SSH@0
                  inputs:
                    sshEndpoint: 'TMS-Production-SSH'
                    runOptions: 'commands'
                    commands: |
                      # Health check
                      sleep 5
                      curl -f http://localhost:5001/login || exit 1
                      echo "Production deployment successful!"
                    readyTimeout: '20000'
                  displayName: 'Health Check'

                - task: SSH@0
                  condition: failed()
                  inputs:
                    sshEndpoint: 'TMS-Production-SSH'
                    runOptions: 'inline'
                    inline: |
                      echo "Rolling back to previous deployment..." && \
                      sudo systemctl stop tms && \
                      LATEST_BACKUP=$(ls -t /tmp/tms-backup-*.tar.gz 2>/dev/null | head -n1) && \
                      [ -n "$LATEST_BACKUP" ] && [ -f "$LATEST_BACKUP" ] && sudo rm -rf /var/www/tms && sudo mkdir -p /var/www/tms && sudo tar -xzf "$LATEST_BACKUP" -C /var/www && sudo chown -R www-data:www-data /var/www/tms && sudo chmod -R 755 /var/www/tms && sudo systemctl start tms && echo "Rollback completed from $LATEST_BACKUP" || (echo "No backup found, rollback not possible!" && exit 1)
                    readyTimeout: '20000'
                  displayName: 'Rollback on Failure'

                - task: SSH@0
                  inputs:
                    sshEndpoint: 'TMS-Production-SSH'
                    runOptions: 'commands'
                    commands: |
                      # Log deployment
                      echo "$(date): Deployed build $(Build.BuildId)" >> /var/www/tms/deployment.log
                    readyTimeout: '20000'
                  displayName: 'Log Deployment'

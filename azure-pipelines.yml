# Azure DevOps CI/CD Pipeline for TMS Flask Application

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

variables:
  pythonVersion: '3.9'
  
stages:
  # ==========================================
  # Stage 1: Build and Test
  # ==========================================
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildJob
        displayName: 'Build Application'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(Build.SourcesDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/tms-$(Build.BuildId).zip'
              replaceExistingArchive: true
            displayName: 'Archive Application'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'tms-app'
              publishLocation: 'Container'
            displayName: 'Publish Artifact'

  # ==========================================
  # Stage 2: Deploy to Production
  # ==========================================
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployProductionJob
        displayName: 'Deploy to Production Server'
        environment: 'TMS-Production'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'tms-app'
                    downloadPath: '$(System.ArtifactsDirectory)'

                - task: SSH@0
                  inputs:
                    sshEndpoint: 'TMS-Production-SSH'
                    runOptions: 'commands'
                    commands: |
                      # Backup current version
                      sudo mkdir -p /var/www/tms/backups
                      sudo tar -czf /var/www/tms/backups/tms-backup-$(date +%Y%m%d-%H%M%S).tar.gz \
                        --exclude='/var/www/tms/venv' \
                        --exclude='/var/www/tms/logs' \
                        --exclude='/var/www/tms/uploads' \
                        /var/www/tms
                      
                      # Keep only last 5 backups
                      cd /var/www/tms/backups
                      sudo bash -c 'ls -t | tail -n +6 | xargs rm -f'
                      
                      # Stop the service
                      sudo systemctl stop tms
                    readyTimeout: '20000'
                  displayName: 'Backup and Stop Service'

                - task: CopyFilesOverSSH@0
                  inputs:
                    sshEndpoint: 'TMS-Production-SSH'
                    sourceFolder: '$(System.ArtifactsDirectory)/tms-app/'
                    contents: '**/*.zip'
                    targetFolder: '/tmp/tms-deploy'
                    cleanTargetFolder: true
                  displayName: 'Copy Files to Server'

                - task: SSH@0
                  inputs:
                    sshEndpoint: 'TMS-Production-SSH'
                    runOptions: 'commands'
                    commands: |
                      # Extract and deploy
                      cd /tmp/tms-deploy
                      sudo unzip -o *.zip -d /var/www/tms
                      
                      # Update virtualenv
                      cd /var/www/tms
                      sudo -u www-data bash -c 'source venv/bin/activate && pip install -r requirements.txt'
                      
                      # Set permissions
                      sudo chown -R www-data:www-data /var/www/tms
                      sudo chmod -R 755 /var/www/tms
                      
                      # Ensure .env exists
                      if [ ! -f /var/www/tms/.env ]; then
                        echo "ERROR: .env file missing!"
                        exit 1
                      fi
                      
                      # Restart service
                      sudo systemctl start tms
                      sudo systemctl status tms
                    readyTimeout: '20000'
                  displayName: 'Deploy and Restart Service'

                - task: SSH@0
                  inputs:
                    sshEndpoint: 'TMS-Production-SSH'
                    runOptions: 'commands'
                    commands: |
                      # Health check
                      sleep 5
                      curl -f http://localhost:5001/login || exit 1
                      echo "Production deployment successful!"
                    readyTimeout: '20000'
                  displayName: 'Health Check'

                - task: SSH@0
                  inputs:
                    sshEndpoint: 'TMS-Production-SSH'
                    runOptions: 'commands'
                    commands: |
                      # Log deployment
                      echo "$(date): Deployed build $(Build.BuildId)" >> /var/www/tms/deployment.log
                    readyTimeout: '20000'
                  displayName: 'Log Deployment'
